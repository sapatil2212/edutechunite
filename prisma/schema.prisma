// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum InstitutionType {
  SCHOOL
  INSTITUTE
  COLLEGE
  COACHING
}

enum SchoolType {
  PRESCHOOL
  PRIMARY
  MIDDLE
  SECONDARY
  SENIOR_SECONDARY
  INTEGRATED
}

enum UserRole {
  SUPER_ADMIN
  SCHOOL_ADMIN
  TEACHER
  STUDENT
  PARENT
  STAFF
}

enum UserStatus {
  PENDING
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum SchoolStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  INACTIVE
}

enum CourseType {
  ACADEMIC
  CERTIFICATION
  TRAINING
  COACHING
}

enum CourseStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

// ============================================
// MODELS
// ============================================

model School {
  id                String          @id @default(cuid())
  schoolId          String          @unique @db.VarChar(20) // Random unique ID like "EDU-XXXX-XXXX"
  
  // Institution Type
  institutionType   InstitutionType
  schoolType        SchoolType?     // Only for SCHOOL type institutions
  
  // Basic Details
  name              String          @db.VarChar(255)
  address           String          @db.Text
  city              String          @db.VarChar(100)
  state             String          @db.VarChar(100)
  district          String?         @db.VarChar(100)
  pincode           String?         @db.VarChar(10)
  
  // Contact Info
  email             String          @unique @db.VarChar(255)
  phone             String          @db.VarChar(20)
  website           String?         @db.VarChar(255)
  
  // Branding
  logo              String?         @db.VarChar(500)
  
  // Status & Verification
  status            SchoolStatus    @default(PENDING_VERIFICATION)
  isVerified        Boolean         @default(false)
  verifiedAt        DateTime?
  
  // Subscription & Limits
  maxStudents       Int             @default(100)
  maxTeachers       Int             @default(20)
  maxStaff          Int             @default(10)
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  users               User[]
  courses             Course[]
  academicYears       AcademicYear[]
  academicUnits       AcademicUnit[]
  subjects            Subject[]
  teachers            Teacher[]
  timetableTemplates  TimetableTemplate[]
  timetableSlots      TimetableSlot[]
  timetables          Timetable[]
  
  // Student Module Relations
  students            Student[]
  guardians           Guardian[]
  attendances         Attendance[]
  leaveRequests       LeaveRequest[]
  homeworks           Homework[]
  exams               Exam[]
  resources           Resource[]
  notices             Notice[]
  notifications       Notification[]
  feeStructures       FeeStructure[]
  studentFees         StudentFee[]
  
  // Assignment Module Relations
  assignments         Assignment[]
  
  // Teacher Assignment Module Relations
  classTeachers            ClassTeacher[]
  teacherClassAssignments  TeacherClassAssignment[]
  
  // Exam Management Module Relations
  examAttendance      ExamAttendance[]
  examSummaries       StudentExamSummary[]
  examNotifications   ExamNotification[]
  hallTickets         ExamHallTicket[]
  questionPapers      ExamQuestionPaper[]
  answerSheets        ExamAnswerSheet[]
  gradingSchemes      GradingScheme[]
  
  // New Exam Timetable System Relations
  examTimetables      ExamTimetable[]     @relation("SchoolExamTimetables")
  auditLogs           AuditLog[]          @relation("SchoolAuditLogs")
  signatures          InstitutionSignature[] @relation("SchoolSignatures")
  reportCards         ReportCard[]        @relation("SchoolReportCards")
  performanceComparisons ExamPerformanceComparison[]
  seatingArrangements ExamSeatingArrangement[]
  invigilatorDuties   InvigilatorDuty[]
  examInsights        ExamInsight[]
  
  // Attendance Configuration
  attendanceConfig         AttendanceConfig?
  
  @@index([institutionType])
  @@index([state, city])
  @@index([status])
  @@map("schools")
}

model User {
  id                String      @id @default(cuid())
  
  // Authentication
  email             String      @unique @db.VarChar(255)
  username          String?     @unique @db.VarChar(50) // For Admission Number / Parent ID
  password          String      @db.VarChar(255)
  mustChangePassword Boolean     @default(false)
  
  // Profile
  fullName          String      @db.VarChar(255)
  phone             String      @db.VarChar(20)
  avatar            String?     @db.VarChar(500)
  
  // Role & Status
  role              UserRole    @default(SCHOOL_ADMIN)
  status            UserStatus  @default(PENDING)
  
  // Email Verification
  emailVerified     Boolean     @default(false)
  emailVerifiedAt   DateTime?
  verificationToken String?     @unique @db.VarChar(255)
  verificationExpiry DateTime?
  
  // Password Reset
  resetToken        String?     @unique @db.VarChar(255)
  resetTokenExpiry  DateTime?
  
  // School Association (null for SUPER_ADMIN)
  schoolId          String?
  school            School?     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Session tracking
  lastLoginAt       DateTime?
  lastLoginIp       String?     @db.VarChar(50)
  
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  // Relations
  teacherProfile    Teacher?
  studentProfile    Student?
  guardianProfile   Guardian?
  notifications     Notification[]
  loginLogs         LoginLog[]
  passwordResets    PasswordResetOTP[]
  notificationPreferences NotificationPreference?
  
  // Exam Timetable System Relations
  createdTimetables  ExamTimetable[]  @relation("TimetableCreator")
  publishedTimetables ExamTimetable[] @relation("TimetablePublisher")
  timetableNotifications ExamTimetableNotification[] @relation("ExamTimetableNotificationRecipient")
  markedSlotAttendance ExamSlotAttendance[] @relation("AttendanceMarker")
  marksChangeRequests MarksChangeRequest[] @relation("MarksChangeRequester")
  approvedMarksChanges MarksChangeRequest[] @relation("MarksChangeApprover")
  auditLogs          AuditLog[]       @relation("AuditLogUser")
  uploadedSignatures InstitutionSignature[] @relation("SignatureUploader")
  generatedReportCards ReportCard[]   @relation("ReportCardGenerator")
  
  @@index([role])
  @@index([status])
  @@index([schoolId])
  @@map("users")
}

model Session {
  id            String   @id @default(cuid())
  sessionToken  String   @unique @db.VarChar(255)
  userId        String
  expires       DateTime
  createdAt     DateTime @default(now())
  
  @@index([userId])
  @@map("sessions")
}

model VerificationToken {
  identifier String   @db.VarChar(255)
  token      String   @unique @db.VarChar(255)
  expires    DateTime
  
  @@unique([identifier, token])
  @@map("verification_tokens")
}

model LoginLog {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress   String?  @db.VarChar(50)
  userAgent   String?  @db.Text
  status      String   @db.VarChar(20) // SUCCESS, FAILED
  reason      String?  @db.Text
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("login_logs")
}

model PasswordResetOTP {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  otp         String   @db.VarChar(10)
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("password_reset_otps")
}

// ============================================
// ACADEMIC STRUCTURE
// ============================================

model Course {
  id                String          @id @default(cuid())
  schoolId          String
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  name              String          @db.VarChar(255)
  code              String?         @db.VarChar(50)
  description       String?         @db.Text
  type              CourseType      @default(ACADEMIC)
  
  // Duration
  durationValue     Int?            
  durationUnit      String?         @db.VarChar(20) // YEARS, MONTHS, WEEKS, DAYS
  
  status            CourseStatus    @default(ACTIVE)
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relations
  academicUnits     AcademicUnit[]
  subjects          Subject[]
  students          Student[]
  enrollments       StudentEnrollment[]

  @@unique([schoolId, name])
  @@unique([schoolId, code])
  @@index([schoolId])
  @@index([status])
  @@map("courses")
}

enum AcademicUnitType {
  CLASS
  SEMESTER
  BATCH
  YEAR
  TERM
}

model AcademicYear {
  id            String         @id @default(cuid())
  
  // Tenant isolation
  schoolId      String
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Details
  name          String         @db.VarChar(100) // e.g., "2024-2025", "Academic Year 2024"
  startDate     DateTime
  endDate       DateTime
  
  // Status
  isActive      Boolean        @default(false)
  isCurrent     Boolean        @default(false) // Only one can be current per school
  
  // Timestamps
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  
  // Relations
  academicUnits       AcademicUnit[]
  students            Student[]
  enrollments         StudentEnrollment[]
  attendances         Attendance[]
  homeworks           Homework[]
  exams               Exam[]
  resources           Resource[]
  notices             Notice[]
  feeStructures       FeeStructure[]
  assignments         Assignment[]
  
  // Teacher Assignment Module Relations
  classTeachers            ClassTeacher[]
  teacherClassAssignments  TeacherClassAssignment[]
  
  // Exam Timetable System Relations
  examTimetables     ExamTimetable[]  @relation("AcademicYearTimetables")
  reportCards        ReportCard[]     @relation("AcademicYearReportCards")
  
  @@unique([schoolId, name])
  @@index([schoolId, isActive])
  @@index([schoolId, isCurrent])
  @@map("academic_years")
}

model AcademicUnit {
  id              String           @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Hierarchy
  parentId        String?          // NULL for top-level units (Classes), value for sections
  parent          AcademicUnit?    @relation("UnitHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  children        AcademicUnit[]   @relation("UnitHierarchy")
  
  // Details
  name            String           @db.VarChar(100) // e.g., "Class 1", "Section A", "Batch A"
  displayOrder    Int              @default(0)      // For ordering in lists
  type            AcademicUnitType @default(CLASS)
  
  // Course association
  courseId        String?
  course          Course?          @relation(fields: [courseId], references: [id], onDelete: SetNull)
  
  // Academic Year
  academicYearId  String
  academicYear    AcademicYear     @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  
  // Capacity
  maxStudents     Int              @default(40)
  currentStudents Int              @default(0)
  
  // Status
  isActive        Boolean          @default(true)
  
  // Metadata (for flexible attributes)
  metadata        Json?            // Store additional attributes like room number, class teacher, etc.
  
  // Timestamps
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  
  // Relations
  timetableSlots      TimetableSlot[]
  timetables          Timetable[]
  students            Student[]
  enrollments         StudentEnrollment[]
  attendances         Attendance[]
  homeworks           Homework[]
  examSchedules       ExamSchedule[]
  resources           Resource[]
  feeStructures       FeeStructure[]
  assignments         Assignment[]
  assignmentSections  Assignment[]          @relation("AssignmentSection")
  
  // Teacher Assignment Module Relations
  classTeachers            ClassTeacher[]
  teacherClassAssignments  TeacherClassAssignment[]
  
  // Subject Relations
  academicUnitSubjects     AcademicUnitSubject[]
  
  // Exam Timetable System Relations
  examTimetables     ExamTimetable[]  @relation("AcademicUnitTimetables")
  
  @@unique([schoolId, academicYearId, parentId, name])
  @@index([schoolId, academicYearId])
  @@index([schoolId, type])
  @@index([parentId])
  @@index([isActive])
  @@index([courseId])
  @@map("academic_units")
}

// ============================================
// TEACHERS
// ============================================

model Teacher {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // User association (optional - teacher may or may not have login)
  userId          String?         @unique
  user            User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Details
  employeeId      String          @db.VarChar(50)   // Employee/Staff ID
  fullName        String          @db.VarChar(255)
  email           String?         @db.VarChar(255)
  phone           String?         @db.VarChar(20)
  
  // Qualifications
  qualification   String?         @db.VarChar(255)
  specialization  String?         @db.VarChar(255)
  
  // Workload
  maxPeriodsPerDay  Int           @default(6)
  maxPeriodsPerWeek Int           @default(30)
  
  // Status
  isActive        Boolean         @default(true)
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  timetableSlots         TimetableSlot[]
  subjectAssignments     TeacherSubject[]
  homeworks              Homework[]
  assignments            Assignment[]
  evaluations            AssignmentEvaluation[]
  examSummaries          StudentExamSummary[]
  invigilatorDuties      InvigilatorDuty[]
  
  // Teacher Assignment Module Relations
  classTeacherAssignments   ClassTeacher[]
  teacherClassAssignments   TeacherClassAssignment[]
  
  // Exam Timetable System Relations
  supervisedSlots    ExamTimetableSlot[] @relation("SlotSupervisor")
  signatures         InstitutionSignature[] @relation("TeacherSignatures")
  
  // Workload tracking (calculated field)
  currentPeriodsPerWeek  Int             @default(0)
  
  @@unique([schoolId, employeeId])
  @@index([schoolId, isActive])
  @@map("teachers")
}

model TeacherSubject {
  id          String    @id @default(cuid())
  
  teacherId   String
  teacher     Teacher   @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  subjectId   String
  subject     Subject   @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // For which classes this teacher teaches this subject (optional)
  academicUnitIds Json?  // Array of unit IDs
  
  createdAt   DateTime  @default(now())
  
  @@unique([teacherId, subjectId])
  @@index([teacherId])
  @@index([subjectId])
  @@map("teacher_subjects")
}

// ============================================
// SUBJECTS
// ============================================

enum SubjectType {
  CORE        // Mandatory subjects
  ELECTIVE    // Optional subjects
  LANGUAGE    // Language subjects
  PRACTICAL   // Lab/Practical subjects
  ACTIVITY    // Sports, Arts, etc.
}

model Subject {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Details
  name            String        @db.VarChar(100)  // e.g., "Mathematics", "English"
  code            String        @db.VarChar(20)   // e.g., "MATH", "ENG"
  description     String?       @db.Text
  type            SubjectType   @default(CORE)
  
  // Course association
  courseId        String?
  course          Course?       @relation(fields: [courseId], references: [id], onDelete: SetNull)
  
  // Display
  color           String?       @db.VarChar(20)   // For timetable display, e.g., "#3B82F6"
  icon            String?       @db.VarChar(50)   // Icon name for UI
  displayOrder    Int           @default(0)
  
  // Credits/Hours
  creditsPerWeek  Int           @default(0)       // Number of periods per week
  
  // Status
  isActive        Boolean       @default(true)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  timetableSlots     TimetableSlot[]
  teacherAssignments TeacherSubject[]
  attendances        Attendance[]
  homeworks          Homework[]
  examSchedules      ExamSchedule[]
  examResults        ExamResult[]
  resources          Resource[]
  assignments        Assignment[]
  examSummaries      StudentExamSummary[]
  performanceComparisons ExamPerformanceComparison[]
  
  // Teacher Assignment Module Relations
  teacherClassAssignments  TeacherClassAssignment[]
  
  // Academic Unit Subject Relations
  academicUnitSubjects     AcademicUnitSubject[]
  
  // Exam Timetable System Relations
  examTimetableSlots     ExamTimetableSlot[] @relation("SlotSubject")
  
  @@unique([schoolId, code])
  @@index([schoolId, isActive])
  @@index([schoolId, type])
  @@index([courseId])
  @@map("subjects")
}

// Junction table for Academic Units and Subjects (many-to-many)
model AcademicUnitSubject {
  id              String        @id @default(cuid())
  
  // Academic Unit
  academicUnitId  String
  academicUnit    AcademicUnit  @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Subject
  subjectId       String
  subject         Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // Optional: Subject-specific settings for this class
  isElective      Boolean       @default(false)
  displayOrder    Int           @default(0)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([academicUnitId, subjectId])
  @@index([academicUnitId])
  @@index([subjectId])
  @@map("academic_unit_subjects")
}

// ============================================
// TIMETABLE
// ============================================

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

model TimetableTemplate {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Details
  name            String          @db.VarChar(100)  // e.g., "Default Template", "Exam Schedule"
  description     String?         @db.Text
  
  // Period Configuration
  periodsPerDay   Int             @default(8)
  periodDuration  Int             @default(45)      // Duration in minutes
  
  // Working Days
  workingDays     Json            // Array of DayOfWeek, e.g., ["MONDAY", "TUESDAY", ...]
  
  // Status
  isDefault       Boolean         @default(false)
  isActive        Boolean         @default(true)
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  periodTimings   PeriodTiming[]
  timetableSlots  TimetableSlot[]
  timetables      Timetable[]
  
  @@unique([schoolId, name])
  @@index([schoolId, isActive])
  @@map("timetable_templates")
}

model PeriodTiming {
  id              String            @id @default(cuid())
  
  // Template relation
  templateId      String
  template        TimetableTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  // Period details
  periodNumber    Int               // 1, 2, 3, etc.
  name            String            @db.VarChar(50)   // e.g., "Period 1", "Lunch Break"
  startTime       String            @db.VarChar(10)   // e.g., "09:00"
  endTime         String            @db.VarChar(10)   // e.g., "09:45"
  
  // Type
  isBreak         Boolean           @default(false)   // True for breaks, recess, lunch
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@unique([templateId, periodNumber])
  @@index([templateId])
  @@map("period_timings")
}

// Timetable Status for draft/publish workflow
enum TimetableStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Slot Type for special cases
enum SlotType {
  REGULAR     // Normal subject period
  BREAK       // Lunch, recess, short break
  FREE        // Free period
  ASSEMBLY    // Morning assembly
  ACTIVITY    // Sports, arts, club activities
  LAB         // Laboratory/Practical
  COMBINED    // Combined class (multiple sections)
  SPECIAL     // Special event
}

model Timetable {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Template
  templateId      String
  template        TimetableTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  // Class/Section
  academicUnitId  String
  academicUnit    AcademicUnit      @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Version control
  version         Int               @default(1)
  status          TimetableStatus   @default(DRAFT)
  
  // Publishing
  publishedAt     DateTime?
  publishedBy     String?           // User ID who published
  
  // Notes
  notes           String?           @db.Text
  
  // Effective dates (for scheduled timetables)
  effectiveFrom   DateTime?
  effectiveTo     DateTime?
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  slots           TimetableSlot[]
  
  @@unique([templateId, academicUnitId, version])
  @@index([schoolId, status])
  @@index([academicUnitId, status])
  @@map("timetables")
}

model TimetableSlot {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Timetable
  timetableId     String
  timetable       Timetable         @relation(fields: [timetableId], references: [id], onDelete: Cascade)
  
  // Template (for quick queries)
  templateId      String
  template        TimetableTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  // Class/Section
  academicUnitId  String
  academicUnit    AcademicUnit      @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Subject (nullable for breaks/free periods)
  subjectId       String?
  subject         Subject?          @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // Teacher assignment
  teacherId       String?
  teacher         Teacher?          @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  
  // Schedule
  dayOfWeek       DayOfWeek
  periodNumber    Int               // Which period (1, 2, 3, etc.)
  
  // Slot type for special handling
  slotType        SlotType          @default(REGULAR)
  
  // Room/Location (optional)
  room            String?           @db.VarChar(50)
  
  // For combined classes
  combinedWith    Json?             // Array of academicUnitIds if combined class
  
  // Notes
  notes           String?           @db.VarChar(255)
  
  // Status
  isActive        Boolean           @default(true)
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@unique([timetableId, dayOfWeek, periodNumber])
  @@index([schoolId])
  @@index([timetableId])
  @@index([templateId, academicUnitId])
  @@index([teacherId, dayOfWeek, periodNumber])
  @@index([subjectId])
  @@map("timetable_slots")
}

// ============================================
// STUDENT MODULE
// ============================================

enum StudentStatus {
  ACTIVE
  INACTIVE
  ALUMNI
  TRANSFERRED
  EXPELLED
  DROPPED_OUT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum BloodGroup {
  A_POSITIVE
  A_NEGATIVE
  B_POSITIVE
  B_NEGATIVE
  AB_POSITIVE
  AB_NEGATIVE
  O_POSITIVE
  O_NEGATIVE
}

enum DocumentType {
  BIRTH_CERTIFICATE
  TRANSFER_CERTIFICATE
  IDENTITY_CARD
  PASSPORT_PHOTO
  MEDICAL_CERTIFICATE
  PREVIOUS_MARKSHEET
  MIGRATION_CERTIFICATE
  OTHER
}

enum RelationshipType {
  FATHER
  MOTHER
  GUARDIAN
  OTHER
}

model Student {
  id                String          @id @default(cuid())
  
  // Tenant isolation
  schoolId          String
  school            School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // User association (optional - student may or may not have login)
  userId            String?         @unique
  user              User?           @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Admission Details
  admissionNumber   String          @db.VarChar(50)   // Unique within institution
  admissionDate     DateTime        @default(now())
  
  // Personal Information
  firstName         String          @db.VarChar(100)
  middleName        String?         @db.VarChar(100)
  lastName          String          @db.VarChar(100)
  fullName          String          @db.VarChar(255)  // Computed: firstName + middleName + lastName
  dateOfBirth       DateTime
  gender            Gender
  bloodGroup        BloodGroup?
  nationality       String?         @db.VarChar(100)
  
  // Contact Information
  email             String?         @db.VarChar(255)
  phone             String?         @db.VarChar(20)
  emergencyContact  String?         @db.VarChar(20)
  
  // Address
  address           String?         @db.Text
  city              String?         @db.VarChar(100)
  state             String?         @db.VarChar(100)
  pincode           String?         @db.VarChar(10)
  
  // Profile Photo
  profilePhoto      String?         @db.VarChar(500)
  
  // Academic Assignment
  academicYearId    String
  academicYear      AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  academicUnitId    String          // Current class/section/batch
  academicUnit      AcademicUnit    @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Denormalized class and section for easier queries and display
  classId           String?         // Parent academic unit (class)
  className         String?         @db.VarChar(100)  // e.g., "Nursery", "Class 1"
  sectionId         String?         // Section academic unit
  sectionName       String?         @db.VarChar(100)  // e.g., "Section A", "Section B"
  
  // Course association
  courseId          String?
  course            Course?         @relation(fields: [courseId], references: [id], onDelete: SetNull)
  
  // For specific institution types
  stream            String?         @db.VarChar(50)   // Science/Commerce/Arts (for senior secondary)
  program           String?         @db.VarChar(100)  // B.Tech, BBA (for colleges)
  rollNumber        String?         @db.VarChar(50)   // Roll number within class
  
  // Status
  status            StudentStatus   @default(ACTIVE)
  
  // Previous School Info (for transfers)
  previousSchool    String?         @db.VarChar(255)
  previousClass     String?         @db.VarChar(100)
  
  // Metadata (for flexible attributes)
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  // Relations
  guardians           StudentGuardian[]
  documents           StudentDocument[]
  attendances         Attendance[]
  homeworkSubmissions HomeworkSubmission[]
  examResults         ExamResult[]
  leaveRequests       LeaveRequest[]
  enrollmentHistory   StudentEnrollment[]
  fees                StudentFee[]
  assignmentSubmissions AssignmentSubmission[]
  groupMemberships    StudentGroupMember[]
  examAttendance      ExamAttendance[]
  examSummaries       StudentExamSummary[]
  hallTickets         ExamHallTicket[]
  answerSheets        ExamAnswerSheet[]
  performanceComparisons ExamPerformanceComparison[]
  
  // Exam Timetable System Relations
  admitCards         AdmitCard[]      @relation("StudentAdmitCards")
  examSlotAttendance ExamSlotAttendance[] @relation("StudentExamSlotAttendance")
  reportCards        ReportCard[]     @relation("StudentReportCards")
  
  @@unique([schoolId, admissionNumber])
  @@index([schoolId, status])
  @@index([schoolId, academicYearId])
  @@index([schoolId, academicUnitId])
  @@index([schoolId, classId])
  @@index([courseId])
  @@index([userId])
  @@map("students")
}

model StudentEnrollment {
  id              String        @id @default(cuid())
  
  // Student
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Academic Period
  academicYearId  String
  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  academicUnitId  String
  academicUnit    AcademicUnit  @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Course association
  courseId        String?
  course          Course?       @relation(fields: [courseId], references: [id], onDelete: SetNull)
  
  // Enrollment details
  enrollmentDate  DateTime      @default(now())
  exitDate        DateTime?
  rollNumber      String?       @db.VarChar(50)
  
  // Status tracking
  status          StudentStatus @default(ACTIVE)
  exitReason      String?       @db.VarChar(255)
  
  // Promotion tracking
  isPromoted      Boolean?      // null = pending, true = promoted, false = detained
  promotedTo      String?       // Academic unit ID promoted to
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([studentId, academicYearId])
  @@index([studentId])
  @@index([academicYearId])
  @@index([academicUnitId])
  @@index([courseId])
  @@map("student_enrollments")
}

model Guardian {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // User association (for parent portal login)
  userId          String?           @unique
  user            User?             @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  // Personal Details
  fullName        String            @db.VarChar(255)
  relationship    RelationshipType  @default(GUARDIAN)
  
  // Contact Information
  email           String?           @db.VarChar(255)
  phone           String            @db.VarChar(20)
  alternatePhone  String?           @db.VarChar(20)
  
  // Address (if different from student)
  address         String?           @db.Text
  
  // Occupation
  occupation      String?           @db.VarChar(100)
  organization    String?           @db.VarChar(255)
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  students        StudentGuardian[]
  
  @@index([schoolId])
  @@index([userId])
  @@index([phone])
  @@map("guardians")
}

model StudentGuardian {
  id              String    @id @default(cuid())
  
  // Relations
  studentId       String
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardianId      String
  guardian        Guardian  @relation(fields: [guardianId], references: [id], onDelete: Cascade)
  
  // Relationship details
  relationship    RelationshipType @default(GUARDIAN)
  isPrimary       Boolean   @default(false)  // Primary contact for notifications
  canPickup       Boolean   @default(true)   // Authorized for student pickup
  
  // Timestamps
  createdAt       DateTime  @default(now())
  
  @@unique([studentId, guardianId])
  @@index([studentId])
  @@index([guardianId])
  @@map("student_guardians")
}

model StudentDocument {
  id              String        @id @default(cuid())
  
  // Student
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Document details
  documentType    DocumentType
  name            String        @db.VarChar(255)
  description     String?       @db.Text
  fileUrl         String        @db.VarChar(500)
  fileSize        Int?          // Size in bytes
  mimeType        String?       @db.VarChar(100)
  
  // Verification
  isVerified      Boolean       @default(false)
  verifiedBy      String?
  verifiedAt      DateTime?
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([studentId])
  @@index([documentType])
  @@map("student_documents")
}

// ============================================
// ATTENDANCE MODULE
// ============================================

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  ON_LEAVE
  EXCUSED
  HOLIDAY
}

enum AttendanceMode {
  DAILY           // One record per student per day
  PERIOD_WISE     // One record per student per period
  BATCH_SLOT      // For coaching - per batch/slot
}

// Institution-level attendance configuration
model AttendanceConfig {
  id                    String          @id @default(cuid())
  
  // Tenant isolation
  schoolId              String          @unique
  school                School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Attendance Mode
  mode                  AttendanceMode  @default(DAILY)
  
  // Available statuses (enabled flags)
  enableLate            Boolean         @default(true)
  enableHalfDay         Boolean         @default(true)
  enableExcused         Boolean         @default(true)
  
  // Timing settings
  cutoffTime            String?         @db.VarChar(10)   // "10:00" - After this, attendance is locked
  lateThresholdMinutes  Int             @default(15)      // Minutes after start time to be marked late
  
  // Default values
  defaultStatus         AttendanceStatus @default(PRESENT)
  autoMarkHolidays      Boolean         @default(true)
  
  // Correction settings
  allowCorrection       Boolean         @default(true)
  correctionRequiresApproval Boolean    @default(true)
  correctionDeadlineDays Int            @default(7)       // Days after which correction is not allowed
  
  // Working days (JSON array of day names)
  workingDays           Json            @default("[\"MONDAY\",\"TUESDAY\",\"WEDNESDAY\",\"THURSDAY\",\"FRIDAY\",\"SATURDAY\"]")  // Days school is open
  
  // Notifications
  notifyParentOnAbsent  Boolean         @default(true)
  lowAttendanceThreshold Int            @default(75)      // Percentage below which to alert
  
  // Timestamps
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  
  @@map("attendance_configs")
}

model Attendance {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Student
  studentId       String
  student         Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Academic context
  academicYearId  String
  academicYear    AcademicYear      @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  academicUnitId  String
  academicUnit    AcademicUnit      @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Attendance details
  date            DateTime          @db.Date
  status          AttendanceStatus  @default(PRESENT)
  
  // Period-wise attendance (optional - null for daily attendance)
  periodNumber    Int?              // Null for daily attendance
  subjectId       String?
  subject         Subject?          @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  
  // Time tracking (for late marking)
  arrivalTime     String?           @db.VarChar(10)   // "09:15" - actual arrival time
  
  // Additional info
  remarks         String?           @db.VarChar(255)
  
  // Who marked and when
  markedBy        String?           // User ID who marked attendance
  markedAt        DateTime          @default(now())
  
  // Correction tracking
  isModified      Boolean           @default(false)   // Was this corrected?
  originalStatus  AttendanceStatus? // Original status before correction
  
  // Link to leave request (if on leave)
  leaveRequestId  String?
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  corrections     AttendanceCorrection[]
  
  @@unique([studentId, date, periodNumber])
  @@index([schoolId, date])
  @@index([studentId, date])
  @@index([academicUnitId, date])
  @@index([academicYearId, date])
  @@index([markedBy])
  @@map("attendances")
}

// Audit trail for attendance corrections
model AttendanceCorrection {
  id              String            @id @default(cuid())
  
  // Link to attendance record
  attendanceId    String
  attendance      Attendance        @relation(fields: [attendanceId], references: [id], onDelete: Cascade)
  
  // What changed
  previousStatus  AttendanceStatus
  newStatus       AttendanceStatus
  
  // Reason for correction
  reason          String            @db.Text
  
  // Who made the change
  correctedBy     String            // User ID
  correctedAt     DateTime          @default(now())
  
  // Approval workflow (if required)
  requiresApproval Boolean          @default(false)
  approvalStatus  String            @default("PENDING") @db.VarChar(20) // PENDING, APPROVED, REJECTED
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?           @db.VarChar(255)
  
  @@index([attendanceId])
  @@index([correctedBy])
  @@map("attendance_corrections")
}

// Daily attendance summary per student (auto-calculated from period-wise)
model DailyAttendanceSummary {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Student
  studentId       String
  
  // Academic context
  academicYearId  String
  academicUnitId  String
  
  // Date
  date            DateTime          @db.Date
  
  // Summary
  totalPeriods    Int               @default(0)
  presentPeriods  Int               @default(0)
  absentPeriods   Int               @default(0)
  latePeriods     Int               @default(0)
  
  // Calculated overall status
  overallStatus   AttendanceStatus  @default(PRESENT)
  attendancePercentage Float        @default(100)
  
  // Timestamps
  calculatedAt    DateTime          @default(now())
  
  @@unique([studentId, date])
  @@index([schoolId, date])
  @@index([studentId, academicYearId])
  @@map("daily_attendance_summaries")
}

model LeaveRequest {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Student
  studentId       String
  student         Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Leave details
  startDate       DateTime          @db.Date
  endDate         DateTime          @db.Date
  reason          String            @db.Text
  leaveType       String?           @db.VarChar(50)  // Sick, Personal, Emergency, etc.
  
  // Supporting document
  attachmentUrl   String?           @db.VarChar(500)
  
  // Approval workflow
  status          String            @default("PENDING") @db.VarChar(20) // PENDING, APPROVED, REJECTED
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?           @db.VarChar(255)
  
  // Who submitted
  submittedBy     String?           // User ID (parent or student)
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([schoolId, status])
  @@index([studentId])
  @@index([startDate, endDate])
  @@map("leave_requests")
}

// ============================================
// HOMEWORK & ASSIGNMENTS MODULE
// ============================================

enum HomeworkStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  LATE_SUBMITTED
  EVALUATED
  RETURNED
}

model Homework {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Academic context
  academicYearId  String
  academicYear    AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  academicUnitId  String
  academicUnit    AcademicUnit    @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  subjectId       String
  subject         Subject         @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // Assigned by
  teacherId       String?
  teacher         Teacher?        @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  
  // Homework details
  title           String          @db.VarChar(255)
  description     String?         @db.Text
  instructions    String?         @db.Text
  
  // Deadlines
  assignedDate    DateTime        @default(now())
  dueDate         DateTime
  
  // Attachments (stored as JSON array)
  attachments     Json?           // [{name, url, type, size}]
  
  // Settings
  maxMarks        Int?            // Maximum marks (if graded)
  allowLateSubmission Boolean     @default(false)
  requiresSubmission  Boolean     @default(true)
  
  // Status
  status          HomeworkStatus  @default(DRAFT)
  publishedAt     DateTime?
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  submissions     HomeworkSubmission[]
  
  @@index([schoolId, status])
  @@index([academicUnitId, subjectId])
  @@index([teacherId])
  @@index([dueDate])
  @@map("homeworks")
}

model HomeworkSubmission {
  id              String            @id @default(cuid())
  
  // Homework
  homeworkId      String
  homework        Homework          @relation(fields: [homeworkId], references: [id], onDelete: Cascade)
  
  // Student
  studentId       String
  student         Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Submission details
  submissionText  String?           @db.Text
  attachments     Json?             // [{name, url, type, size}]
  
  // Status
  status          SubmissionStatus  @default(PENDING)
  submittedAt     DateTime?
  
  // Evaluation
  marksObtained   Float?
  feedback        String?           @db.Text
  evaluatedBy     String?
  evaluatedAt     DateTime?
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@unique([homeworkId, studentId])
  @@index([homeworkId])
  @@index([studentId])
  @@index([status])
  @@map("homework_submissions")
}

// ============================================
// EXAMS & RESULTS MODULE
// ============================================

enum ExamType {
  UNIT_TEST
  MONTHLY_TEST
  MID_TERM
  FINAL
  PRACTICAL
  ORAL
  VIVA
  PROJECT
  ASSIGNMENT
  MOCK_TEST
  ENTRANCE_TEST
  INTERNAL_ASSESSMENT
  SEMESTER_EXAM
  LAB_EXAM
  ACTIVITY_BASED
  WEEKLY_TEST
  PRACTICE_TEST
  COMPETITIVE_PATTERN
}

enum ExamStatus {
  DRAFT
  SCHEDULED
  ONGOING
  COMPLETED
  MARKS_ENTRY_IN_PROGRESS
  MARKS_ENTRY_COMPLETED
  RESULTS_PUBLISHED
  CANCELLED
  ARCHIVED
}

enum EvaluationType {
  MARKS_BASED
  GRADE_BASED
  PERCENTAGE_BASED
  CREDIT_BASED
  PASS_FAIL
  DESCRIPTIVE
}

enum ExamMode {
  OFFLINE
  ONLINE
  HYBRID
}

model Exam {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Academic context
  academicYearId  String
  academicYear    AcademicYear    @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  
  // Course/Class context
  courseId        String?         // Optional: for course-specific exams
  targetClasses   Json            // Array of academicUnitIds this exam applies to
  
  // Exam details
  name            String          @db.VarChar(255)  // e.g., "Mid-Term Examination 2025-26"
  code            String?         @db.VarChar(50)   // Unique exam code
  description     String?         @db.Text
  examType        ExamType        @default(MID_TERM)
  
  // Schedule
  startDate       DateTime
  endDate         DateTime
  
  // Evaluation Configuration
  evaluationType  EvaluationType  @default(MARKS_BASED)
  examMode        ExamMode        @default(OFFLINE)
  
  // Passing criteria
  overallPassingPercentage Float? @default(33)
  subjectWisePassing      Boolean @default(true)  // Must pass each subject individually
  
  // Status
  status          ExamStatus      @default(DRAFT)
  publishedAt     DateTime?       // When exam was published/scheduled
  publishedBy     String?         // User ID who published
  resultsPublishedAt DateTime?
  resultsPublishedBy String?      // User ID who published results
  
  // Grading configuration
  gradingSystem   Json?           // {A+: {min: 90, max: 100}, A: {min: 80, max: 89}, ...}
  
  // Settings
  showRank        Boolean         @default(false)
  showPercentage  Boolean         @default(true)
  showGrade       Boolean         @default(true)
  allowMarksCorrection Boolean    @default(false)
  correctionDeadline   DateTime?  // After this, no corrections allowed
  
  // Weightage (for term calculation)
  weightage       Float?          @default(100)  // Percentage weightage in final result
  
  // Metadata
  instructions    String?         @db.Text
  createdBy       String?         // User ID who created
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  schedules       ExamSchedule[]
  results         ExamResult[]
  reportCards     ReportCard[]
  marksEntryLogs  MarksEntryLog[]
  attendance      ExamAttendance[]
  summaries       StudentExamSummary[]
  notifications   ExamNotification[]
  hallTickets     ExamHallTicket[]
  questionPapers  ExamQuestionPaper[]
  answerSheets    ExamAnswerSheet[]
  currentExamComparisons ExamPerformanceComparison[] @relation("CurrentExam")
  previousExamComparisons ExamPerformanceComparison[] @relation("PreviousExam")
  seatingArrangements ExamSeatingArrangement[]
  insights        ExamInsight[]
  
  @@unique([schoolId, academicYearId, code])
  @@index([schoolId, academicYearId])
  @@index([status])
  @@map("exams")
}

model ExamSchedule {
  id              String        @id @default(cuid())
  
  // Exam
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Subject
  subjectId       String
  subject         Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // Academic Unit (class/section)
  academicUnitId  String
  academicUnit    AcademicUnit  @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Schedule
  examDate        DateTime      @db.Date
  startTime       String        @db.VarChar(10)   // e.g., "09:00"
  endTime         String        @db.VarChar(10)   // e.g., "12:00"
  duration        Int?          // Duration in minutes
  
  // Venue
  room            String?       @db.VarChar(50)
  center          String?       @db.VarChar(100)  // Exam center name
  
  // Marks Configuration
  maxMarks        Int           @default(100)
  passingMarks    Int           @default(33)
  theoryMarks     Int?          // For subjects with theory+practical split
  practicalMarks  Int?          // For subjects with theory+practical split
  
  // Invigilator/Supervisor
  supervisorId    String?       // Teacher ID
  invigilators    Json?         // Array of teacher IDs
  
  // Status
  isCompleted     Boolean       @default(false)
  marksEntryStatus String       @default("PENDING") @db.VarChar(20) // PENDING, IN_PROGRESS, COMPLETED, LOCKED
  marksEntryLockedAt DateTime?
  marksEntryLockedBy String?    // User ID who locked marks entry
  
  // Instructions
  instructions    String?       @db.Text
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  results         ExamResult[]
  attendance      ExamAttendance[]
  questionPapers  ExamQuestionPaper[]
  answerSheets    ExamAnswerSheet[]
  invigilatorDuties InvigilatorDuty[]
  
  @@unique([examId, subjectId, academicUnitId])
  @@index([examId])
  @@index([academicUnitId])
  @@index([examDate])
  @@index([marksEntryStatus])
  @@map("exam_schedules")
}

model ExamResult {
  id              String        @id @default(cuid())
  
  // Exam context
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  examScheduleId  String?
  examSchedule    ExamSchedule? @relation(fields: [examScheduleId], references: [id], onDelete: Cascade)
  
  // Student
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Subject (denormalized for quick queries)
  subjectId       String
  subject         Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // Marks
  maxMarks        Int           @default(100)
  marksObtained   Float?
  theoryMarks     Float?        // For theory component
  practicalMarks  Float?        // For practical component
  percentage      Float?
  grade           String?       @db.VarChar(10)
  
  // Pass/Fail
  isPassed        Boolean?      // null = not evaluated, true = passed, false = failed
  
  // Rank within class (optional)
  classRank       Int?
  overallRank     Int?          // Rank across all classes in same exam
  
  // Status
  isAbsent        Boolean       @default(false)
  remarks         String?       @db.VarChar(255)
  teacherRemarks  String?       @db.Text
  
  // Entry tracking
  enteredBy       String?       // User ID who entered marks
  enteredAt       DateTime      @default(now())
  
  // Draft/Submit workflow
  isDraft         Boolean       @default(true)
  submittedAt     DateTime?     // When marks were submitted (locked)
  submittedBy     String?       // User ID who submitted
  
  // Verification
  verifiedBy      String?
  verifiedAt      DateTime?
  
  // Correction tracking
  isCorrected     Boolean       @default(false)
  correctionCount Int           @default(0)
  lastCorrectedAt DateTime?
  lastCorrectedBy String?
  
  // Grace marks
  graceMarks      Float?        @default(0)
  graceReason     String?       @db.VarChar(255)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  corrections     MarksCorrection[]
  
  // Exam Timetable System Relations
  changeRequests  MarksChangeRequest[] @relation("ResultChangeRequests")
  
  @@unique([examId, studentId, subjectId])
  @@index([examId])
  @@index([studentId])
  @@index([subjectId])
  @@index([isDraft])
  @@index([isPassed])
  @@map("exam_results")
}

// Marks Correction Audit Trail
model MarksCorrection {
  id              String        @id @default(cuid())
  
  // Result reference
  examResultId    String
  examResult      ExamResult    @relation(fields: [examResultId], references: [id], onDelete: Cascade)
  
  // Previous values
  previousMarks   Float?
  previousTheoryMarks Float?
  previousPracticalMarks Float?
  previousGrade   String?       @db.VarChar(10)
  
  // New values
  newMarks        Float?
  newTheoryMarks  Float?
  newPracticalMarks Float?
  newGrade        String?       @db.VarChar(10)
  
  // Correction details
  reason          String        @db.Text
  correctionType  String        @db.VarChar(50)  // ENTRY_ERROR, REVALUATION, GRACE_MARKS, ADMIN_OVERRIDE
  
  // Approval workflow
  requestedBy     String        // User ID who requested correction
  requestedAt     DateTime      @default(now())
  approvalStatus  String        @default("PENDING") @db.VarChar(20) // PENDING, APPROVED, REJECTED
  approvedBy      String?       // User ID who approved/rejected
  approvedAt      DateTime?
  rejectionReason String?       @db.Text
  
  @@index([examResultId])
  @@index([approvalStatus])
  @@map("marks_corrections")
}

// Marks Entry Activity Log
model MarksEntryLog {
  id              String        @id @default(cuid())
  
  // Exam reference
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Activity details
  action          String        @db.VarChar(50)  // MARKS_ENTERED, MARKS_UPDATED, MARKS_SUBMITTED, MARKS_LOCKED, MARKS_CORRECTED
  entityType      String        @db.VarChar(50)  // EXAM_RESULT, EXAM_SCHEDULE
  entityId        String        // ID of the entity affected
  
  // Details
  description     String?       @db.Text
  metadata        Json?         // Additional data about the action
  
  // Who performed the action
  performedBy     String        // User ID
  performedAt     DateTime      @default(now())
  
  // IP tracking
  ipAddress       String?       @db.VarChar(50)
  
  @@index([examId, performedAt])
  @@index([performedBy])
  @@index([action])
  @@map("marks_entry_logs")
}

// Report Card Generation
enum ReportCardType {
  EXAM_WISE
  TERM_WISE
  ANNUAL
  PROGRESS_REPORT
  TRANSCRIPT
}

enum ReportCardStatus {
  DRAFT
  GENERATED
  PUBLISHED
  ARCHIVED
}

model ReportCard {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School            @relation("SchoolReportCards", fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Student
  studentId       String
  student         Student           @relation("StudentReportCards", fields: [studentId], references: [id], onDelete: Cascade)
  
  // Exam reference (can be multiple exams for term/annual reports)
  examId          String?
  exam            Exam?             @relation(fields: [examId], references: [id], onDelete: Cascade)
  examIds         Json?             // Array of exam IDs for consolidated reports
  
  // Exam Timetable reference (optional)
  timetableId     String?
  timetable       ExamTimetable?    @relation("TimetableReportCards", fields: [timetableId], references: [id], onDelete: SetNull)
  
  // Academic context
  academicYearId  String
  academicYear    AcademicYear      @relation("AcademicYearReportCards", fields: [academicYearId], references: [id], onDelete: Cascade)
  academicUnitId  String            // Class/Section
  
  // Report details
  reportCardType  ReportCardType    @default(EXAM_WISE)
  title           String            @db.VarChar(255)
  reportPeriod    String            @db.VarChar(100)  // e.g., "First Term 2024-25"
  
  // Content
  resultsData     Json              // Consolidated results data
  attendanceData  Json?             // Attendance summary
  remarksData     Json?             // Teacher remarks, principal remarks
  
  // File
  fileUrl         String?           @db.VarChar(500)  // PDF URL
  fileSize        Int?              // Size in bytes
  
  // Status
  status          ReportCardStatus  @default(DRAFT)
  generatedAt     DateTime?
  generatedBy     String?           // User ID who generated
  generator       User?             @relation("ReportCardGenerator", fields: [generatedBy], references: [id])
  publishedAt     DateTime?
  publishedBy     String?           // User ID who published
  
  // Download tracking
  downloadCount   Int               @default(0)
  lastDownloadedAt DateTime?
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([schoolId, studentId])
  @@index([examId])
  @@index([timetableId])
  @@index([academicYearId])
  @@index([status])
  @@map("report_cards")
}

// Exam Analytics & Performance Tracking
model ExamAnalytics {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Exam reference
  examId          String
  
  // Academic context
  academicUnitId  String?       // Null for school-wide analytics
  subjectId       String?       // Null for overall analytics
  
  // Analytics data
  totalStudents   Int           @default(0)
  appearedStudents Int          @default(0)
  absentStudents  Int           @default(0)
  passedStudents  Int           @default(0)
  failedStudents  Int           @default(0)
  
  // Marks statistics
  highestMarks    Float?
  lowestMarks     Float?
  averageMarks    Float?
  medianMarks     Float?
  
  // Grade distribution
  gradeDistribution Json?       // {A+: 10, A: 20, B: 30, ...}
  
  // Performance bands
  above90         Int           @default(0)
  between75And90  Int           @default(0)
  between60And75  Int           @default(0)
  between33And60  Int           @default(0)
  below33         Int           @default(0)
  
  // Comparison data
  previousExamAverage Float?    // For trend analysis
  improvementPercentage Float?
  
  // Calculated at
  calculatedAt    DateTime      @default(now())
  
  @@unique([examId, academicUnitId, subjectId])
  @@index([schoolId, examId])
  @@map("exam_analytics")
}

// Exam Attendance Tracking
model ExamAttendance {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam and Schedule reference
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  examScheduleId  String
  examSchedule    ExamSchedule  @relation(fields: [examScheduleId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Attendance details
  isPresent       Boolean       @default(false)
  arrivalTime     DateTime?
  departureTime   DateTime?
  
  // Additional info
  lateArrival     Boolean       @default(false)
  earlyDeparture  Boolean       @default(false)
  remarks         String?       @db.Text
  
  // Marked by
  markedBy        String        // Teacher/Invigilator user ID
  markedAt        DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([examScheduleId, studentId])
  @@index([examId, studentId])
  @@index([examScheduleId])
  @@index([markedBy])
  @@map("exam_attendance")
}

// Student Exam Summary (by teacher)
model StudentExamSummary {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam reference
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Subject reference (optional - for subject-wise summary)
  subjectId       String?
  subject         Subject?      @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  
  // Summary details
  overallPerformance String     @db.VarChar(50) // EXCELLENT, GOOD, AVERAGE, BELOW_AVERAGE, POOR
  strengths       String?       @db.Text
  weaknesses      String?       @db.Text
  recommendations String?       @db.Text
  behaviorRemarks String?       @db.Text
  
  // Ratings (1-5 scale)
  preparednessRating Int?       @db.SmallInt
  participationRating Int?      @db.SmallInt
  disciplineRating Int?         @db.SmallInt
  
  // Created by teacher
  teacherId       String
  teacher         Teacher       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([examId, studentId, subjectId])
  @@index([examId, teacherId])
  @@index([studentId])
  @@map("student_exam_summaries")
}

// Exam Notifications
enum ExamNotificationType {
  SCHEDULE_PUBLISHED
  SCHEDULE_UPDATED
  EXAM_REMINDER
  MARKS_PUBLISHED
  RESULT_PUBLISHED
  REPORT_CARD_READY
  EXAM_CANCELLED
  EXAM_RESCHEDULED
  ATTENDANCE_MARKED
}

model ExamNotification {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam reference
  examId          String?
  exam            Exam?         @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Notification details
  type            ExamNotificationType
  title           String        @db.VarChar(255)
  message         String        @db.Text
  
  // Target users
  recipientType   String        @db.VarChar(50) // STUDENT, PARENT, TEACHER, ALL_STUDENTS, SPECIFIC_CLASS
  recipientId     String?       // Specific user ID if targeted
  academicUnitId  String?       // If targeting specific class
  
  // Delivery channels
  sendEmail       Boolean       @default(true)
  sendInApp       Boolean       @default(true)
  sendSMS         Boolean       @default(false)
  
  // Status tracking
  isRead          Boolean       @default(false)
  readAt          DateTime?
  emailSent       Boolean       @default(false)
  emailSentAt     DateTime?
  smsSent         Boolean       @default(false)
  smsSentAt       DateTime?
  
  // Metadata
  metadata        Json?         // Additional data (exam schedule details, etc.)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  scheduledFor    DateTime?     // For scheduled notifications (reminders)
  
  @@index([schoolId, recipientId, isRead])
  @@index([examId])
  @@index([type, createdAt])
  @@index([scheduledFor])
  @@map("exam_notifications")
}

// Exam Hall Ticket
model ExamHallTicket {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam reference
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Hall ticket details
  hallTicketNumber String       @unique @db.VarChar(50)
  
  // Seating arrangement
  examCenter      String?       @db.VarChar(255)
  roomNumber      String?       @db.VarChar(100)
  seatNumber      String?       @db.VarChar(50)
  
  // Instructions
  instructions    String?       @db.Text
  reportingTime   DateTime?
  
  // Status
  isGenerated     Boolean       @default(false)
  generatedAt     DateTime?
  isDownloaded    Boolean       @default(false)
  downloadedAt    DateTime?
  downloadCount   Int           @default(0)
  
  // QR Code for verification
  qrCode          String?       @db.Text
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([examId, studentId])
  @@index([hallTicketNumber])
  @@index([examId])
  @@map("exam_hall_tickets")
}

// Exam Question Paper Management
model ExamQuestionPaper {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam and Schedule reference
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  examScheduleId  String
  examSchedule    ExamSchedule  @relation(fields: [examScheduleId], references: [id], onDelete: Cascade)
  
  // Paper details
  title           String        @db.VarChar(255)
  paperCode       String?       @db.VarChar(50)
  setNumber       String?       @db.VarChar(10) // Set A, B, C for multiple sets
  
  // File details
  fileUrl         String        @db.Text
  fileName        String        @db.VarChar(255)
  fileSize        Int?          // in bytes
  fileType        String?       @db.VarChar(50)
  
  // Security
  isConfidential  Boolean       @default(true)
  password        String?       @db.VarChar(255)
  
  // Access control
  uploadedBy      String        // Teacher/Admin user ID
  uploadedAt      DateTime      @default(now())
  
  // Status
  status          String        @default("DRAFT") @db.VarChar(50) // DRAFT, APPROVED, PUBLISHED
  approvedBy      String?
  approvedAt      DateTime?
  
  @@index([examScheduleId])
  @@index([examId])
  @@map("exam_question_papers")
}

// Exam Answer Sheet Management
model ExamAnswerSheet {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam and Schedule reference
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  examScheduleId  String
  examSchedule    ExamSchedule  @relation(fields: [examScheduleId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Answer sheet details
  sheetNumber     String?       @db.VarChar(50)
  
  // File upload (scanned copy)
  fileUrl         String?       @db.Text
  fileName        String?       @db.VarChar(255)
  fileSize        Int?
  
  // Submission details
  isSubmitted     Boolean       @default(false)
  submittedAt     DateTime?
  submissionMode  String?       @db.VarChar(50) // PHYSICAL, ONLINE, HYBRID
  
  // Evaluation tracking
  assignedTo      String?       // Teacher ID for evaluation
  assignedAt      DateTime?
  evaluationStatus String       @default("PENDING") @db.VarChar(50) // PENDING, IN_PROGRESS, COMPLETED
  evaluatedAt     DateTime?
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([examScheduleId, studentId])
  @@index([examId, studentId])
  @@index([assignedTo, evaluationStatus])
  @@map("exam_answer_sheets")
}

// Grade Boundaries and Grading Scheme
model GradingScheme {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Scheme details
  name            String        @db.VarChar(255)
  description     String?       @db.Text
  
  // Grade boundaries (JSON array)
  // [{grade: "A+", minPercentage: 90, maxPercentage: 100, gradePoint: 10, description: "Outstanding"}]
  boundaries      Json
  
  // Settings
  isDefault       Boolean       @default(false)
  isActive        Boolean       @default(true)
  
  // Applicable to
  applicableExamTypes Json?     // Array of exam types this scheme applies to
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([schoolId, isActive])
  @@map("grading_schemes")
}

// Exam Performance Comparison
model ExamPerformanceComparison {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Subject reference
  subjectId       String
  subject         Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // Current exam
  currentExamId   String
  currentExam     Exam          @relation("CurrentExam", fields: [currentExamId], references: [id], onDelete: Cascade)
  currentMarks    Float
  currentPercentage Float
  
  // Previous exam
  previousExamId  String?
  previousExam    Exam?         @relation("PreviousExam", fields: [previousExamId], references: [id], onDelete: SetNull)
  previousMarks   Float?
  previousPercentage Float?
  
  // Comparison metrics
  marksImprovement Float?       // Difference in marks
  percentageImprovement Float?  // Difference in percentage
  rankImprovement Int?          // Difference in rank
  trend           String        @db.VarChar(20) // IMPROVING, DECLINING, STABLE
  
  // Analysis
  performanceLevel String       @db.VarChar(50) // EXCELLENT, GOOD, AVERAGE, NEEDS_IMPROVEMENT
  recommendations String?       @db.Text
  
  // Timestamps
  createdAt       DateTime      @default(now())
  
  @@unique([studentId, subjectId, currentExamId])
  @@index([schoolId, studentId])
  @@index([currentExamId])
  @@map("exam_performance_comparisons")
}

// Exam Seating Arrangement
model ExamSeatingArrangement {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam reference
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Venue details
  venueName       String        @db.VarChar(255)
  roomNumber      String        @db.VarChar(100)
  capacity        Int
  
  // Seating configuration
  rowsCount       Int
  seatsPerRow     Int
  
  // Seating plan (JSON)
  // [{row: 1, seat: 1, studentId: "xxx", rollNumber: "001"}]
  seatingPlan     Json
  
  // Settings
  alternateSeating Boolean      @default(true) // Alternate students from different classes
  randomSeating   Boolean       @default(false)
  
  // Status
  isGenerated     Boolean       @default(false)
  generatedAt     DateTime?
  generatedBy     String?       // User ID
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([examId])
  @@index([schoolId])
  @@map("exam_seating_arrangements")
}

// Invigilator Duty Roster
model InvigilatorDuty {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam schedule reference
  examScheduleId  String
  examSchedule    ExamSchedule  @relation(fields: [examScheduleId], references: [id], onDelete: Cascade)
  
  // Teacher reference
  teacherId       String
  teacher         Teacher       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Duty details
  dutyType        String        @db.VarChar(50) // CHIEF_INVIGILATOR, INVIGILATOR, RELIEF_INVIGILATOR
  venueName       String?       @db.VarChar(255)
  roomNumber      String?       @db.VarChar(100)
  
  // Time
  startTime       DateTime
  endTime         DateTime
  
  // Status
  status          String        @default("ASSIGNED") @db.VarChar(50) // ASSIGNED, CONFIRMED, COMPLETED, ABSENT
  confirmedAt     DateTime?
  
  // Notes
  specialInstructions String?   @db.Text
  remarks         String?       @db.Text
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@unique([examScheduleId, teacherId])
  @@index([teacherId, status])
  @@index([examScheduleId])
  @@map("invigilator_duties")
}

// Notification Preferences
model NotificationPreference {
  id              String        @id @default(cuid())
  
  // User reference
  userId          String        @unique
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Email preferences
  emailEnabled    Boolean       @default(true)
  emailExamSchedule Boolean     @default(true)
  emailExamReminder Boolean     @default(true)
  emailMarksPublished Boolean   @default(true)
  emailResultPublished Boolean  @default(true)
  emailReportCard Boolean       @default(true)
  
  // In-app preferences
  inAppEnabled    Boolean       @default(true)
  inAppExamSchedule Boolean     @default(true)
  inAppExamReminder Boolean     @default(true)
  inAppMarksPublished Boolean   @default(true)
  inAppResultPublished Boolean  @default(true)
  
  // SMS preferences
  smsEnabled      Boolean       @default(false)
  smsExamReminder Boolean       @default(false)
  smsResultPublished Boolean    @default(false)
  
  // Reminder timing preferences
  reminderDaysBefore Json?      // Array of days [7, 3, 1]
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@map("notification_preferences")
}

// Exam Statistics and Insights
model ExamInsight {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Exam reference
  examId          String
  exam            Exam          @relation(fields: [examId], references: [id], onDelete: Cascade)
  
  // Insight type
  insightType     String        @db.VarChar(100) // DIFFICULTY_ANALYSIS, PERFORMANCE_TREND, SUBJECT_COMPARISON, etc.
  
  // Insight data
  title           String        @db.VarChar(255)
  description     String        @db.Text
  
  // Metrics (JSON)
  metrics         Json          // Detailed metrics and data
  
  // Severity/Priority
  severity        String?       @db.VarChar(50) // HIGH, MEDIUM, LOW
  
  // Recommendations
  recommendations String?       @db.Text
  
  // Status
  isActionable    Boolean       @default(false)
  isResolved      Boolean       @default(false)
  resolvedAt      DateTime?
  
  // Timestamps
  generatedAt     DateTime      @default(now())
  
  @@index([examId, insightType])
  @@index([schoolId, isResolved])
  @@map("exam_insights")
}

// ============================================
// DIGITAL RESOURCES MODULE
// ============================================

enum ResourceType {
  PDF
  VIDEO
  LINK
  DOCUMENT
  IMAGE
  AUDIO
  OTHER
}

model Resource {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Academic context
  academicYearId  String?
  academicYear    AcademicYear? @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  academicUnitId  String?       // If class-specific
  academicUnit    AcademicUnit? @relation(fields: [academicUnitId], references: [id], onDelete: SetNull)
  subjectId       String?
  subject         Subject?      @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  
  // Resource details
  title           String        @db.VarChar(255)
  description     String?       @db.Text
  resourceType    ResourceType  @default(PDF)
  
  // File/URL
  fileUrl         String        @db.VarChar(500)
  thumbnailUrl    String?       @db.VarChar(500)
  fileSize        Int?          // Size in bytes
  mimeType        String?       @db.VarChar(100)
  
  // Organization
  chapter         String?       @db.VarChar(100)  // Chapter/Topic name
  displayOrder    Int           @default(0)
  tags            Json?         // Array of tags for searching
  
  // Access control
  isPublic        Boolean       @default(false)   // Visible to all classes
  allowDownload   Boolean       @default(true)
  
  // Uploaded by
  uploadedBy      String?
  
  // Status
  isActive        Boolean       @default(true)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  @@index([schoolId, isActive])
  @@index([academicUnitId])
  @@index([subjectId])
  @@index([resourceType])
  @@map("resources")
}

// ============================================
// NOTICES & ANNOUNCEMENTS MODULE
// ============================================

enum NoticeType {
  GENERAL
  ACADEMIC
  EVENT
  HOLIDAY
  FEE_REMINDER
  EXAM
  EMERGENCY
  ADMINISTRATIVE
}

enum NoticePriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum NoticeTargetType {
  ALL           // All users
  STUDENTS      // All students
  PARENTS       // All parents
  TEACHERS      // All teachers
  CLASS         // Specific class
  INDIVIDUAL    // Specific users
}

model Notice {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Notice details
  title           String            @db.VarChar(255)
  content         String            @db.Text
  noticeType      NoticeType        @default(GENERAL)
  priority        NoticePriority    @default(MEDIUM)
  
  // Targeting
  targetType      NoticeTargetType  @default(ALL)
  targetIds       Json?             // Array of user/class IDs based on targetType
  
  // Academic context (optional)
  academicYearId  String?
  academicYear    AcademicYear?     @relation(fields: [academicYearId], references: [id], onDelete: SetNull)
  
  // Attachments
  attachments     Json?             // [{name, url, type}]
  
  // Publishing
  isPublished     Boolean           @default(false)
  publishedAt     DateTime?
  publishedBy     String?
  
  // Scheduling
  scheduledFor    DateTime?         // For scheduled notices
  expiresAt       DateTime?         // Auto-archive after this date
  
  // Created by
  createdBy       String?
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  @@index([schoolId, isPublished])
  @@index([schoolId, noticeType])
  @@index([publishedAt])
  @@map("notices")
}

// ============================================
// NOTIFICATIONS MODULE
// ============================================

enum NotificationChannel {
  IN_APP
  EMAIL
  SMS
  PUSH
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

model Notification {
  id              String              @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Recipient
  userId          String
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Notification details
  title           String              @db.VarChar(255)
  message         String              @db.Text
  channel         NotificationChannel @default(IN_APP)
  
  // Reference (what triggered this notification)
  referenceType   String?             @db.VarChar(50)   // e.g., "homework", "exam", "notice"
  referenceId     String?             // ID of the referenced entity
  
  // Action URL
  actionUrl       String?             @db.VarChar(500)
  
  // Status
  status          NotificationStatus  @default(PENDING)
  sentAt          DateTime?
  readAt          DateTime?
  
  // Timestamps
  createdAt       DateTime            @default(now())
  
  @@index([userId, status])
  @@index([schoolId, createdAt])
  @@index([userId, readAt])
  @@map("notifications")
}

// ============================================
// FINANCE MODULE (COMPLETE)
// ============================================

enum FeeType {
  TUITION
  ADMISSION
  EXAMINATION
  LIBRARY
  LABORATORY
  TRANSPORT
  HOSTEL
  ACTIVITY
  UNIFORM
  BOOKS
  SPORTS
  MISCELLANEOUS
  OTHER
}

enum FeeFrequency {
  ONE_TIME
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  ANNUAL
  CUSTOM
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  WAIVED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CHEQUE
  DEMAND_DRAFT
  BANK_TRANSFER
  ONLINE
  UPI
  CARD
  NET_BANKING
}

enum PaymentGatewayStatus {
  INITIATED
  PENDING
  SUCCESS
  FAILED
  CANCELLED
  REFUNDED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum ScholarshipStatus {
  PENDING
  APPROVED
  REJECTED
  ACTIVE
  EXPIRED
}

enum RefundStatus {
  INITIATED
  PENDING_APPROVAL
  APPROVED
  REJECTED
  PROCESSED
  COMPLETED
  CANCELLED
}

enum InvoiceStatus {
  DRAFT
  GENERATED
  SENT
  PAID
  PARTIALLY_PAID
  OVERDUE
  CANCELLED
}

// ============================================
// FEE STRUCTURE SETUP
// ============================================

model FeeStructure {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Academic context
  academicYearId  String
  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  
  // Applicable to (hierarchical)
  courseId        String?       // If course-specific
  academicUnitId  String?       // If class/section-specific
  academicUnit    AcademicUnit? @relation(fields: [academicUnitId], references: [id], onDelete: SetNull)
  
  // Structure details
  name            String        @db.VarChar(255)  // e.g., "Class 10 - Science Stream Fee Structure 2024-25"
  description     String?       @db.Text
  
  // Status
  isActive        Boolean       @default(true)
  isLocked        Boolean       @default(false)   // Cannot be modified once students are assigned
  
  // Metadata
  createdBy       String?       // User ID
  approvedBy      String?       // User ID
  approvedAt      DateTime?
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  components      FeeComponent[]
  studentFees     StudentFee[]
  
  @@unique([schoolId, academicYearId, name])
  @@index([schoolId, academicYearId])
  @@index([academicUnitId])
  @@index([isActive])
  @@map("fee_structures")
}

model FeeComponent {
  id              String        @id @default(cuid())
  
  // Fee Structure
  feeStructureId  String
  feeStructure    FeeStructure  @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  
  // Component details
  name            String        @db.VarChar(255)  // e.g., "Tuition Fee", "Lab Fee"
  feeType         FeeType       @default(TUITION)
  description     String?       @db.Text
  
  // Amount
  amount          Float
  
  // Frequency & Schedule
  frequency       FeeFrequency  @default(ONE_TIME)
  isMandatory     Boolean       @default(true)
  
  // Due dates (can have multiple installments)
  dueDate         DateTime?     // Primary due date
  
  // Settings
  allowPartialPayment Boolean   @default(true)
  lateFeeApplicable   Boolean   @default(false)
  lateFeeAmount       Float?
  lateFeePercentage   Float?    // Percentage per day/month
  
  // Display order
  displayOrder    Int           @default(0)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  installments    FeeInstallment[]
  
  @@index([feeStructureId])
  @@map("fee_components")
}

model FeeInstallment {
  id              String        @id @default(cuid())
  
  // Fee Component
  feeComponentId  String
  feeComponent    FeeComponent  @relation(fields: [feeComponentId], references: [id], onDelete: Cascade)
  
  // Installment details
  installmentNumber Int         // 1, 2, 3, etc.
  name            String        @db.VarChar(100)  // e.g., "1st Installment", "January Fee"
  amount          Float
  dueDate         DateTime
  
  // Timestamps
  createdAt       DateTime      @default(now())
  
  @@unique([feeComponentId, installmentNumber])
  @@index([feeComponentId])
  @@map("fee_installments")
}

// ============================================
// STUDENT FEE ASSIGNMENT
// ============================================

model StudentFee {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Student
  studentId       String
  student         Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Fee structure
  feeStructureId  String
  feeStructure    FeeStructure    @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  
  // Academic context
  academicYearId  String
  
  // Amount breakdown
  totalAmount     Float           // Original total
  discountAmount  Float           @default(0)
  scholarshipAmount Float         @default(0)
  taxAmount       Float           @default(0)
  finalAmount     Float           // After discounts/scholarships
  paidAmount      Float           @default(0)
  balanceAmount   Float           // Remaining to be paid
  
  // Status
  status          PaymentStatus   @default(PENDING)
  dueDate         DateTime?
  
  // Payment plan
  isCustomPlan    Boolean         @default(false)
  customPlanDetails Json?         // Custom installment details
  
  // Assignment details
  assignedBy      String?         // User ID
  assignedAt      DateTime        @default(now())
  
  // Override flag (manual adjustment)
  isOverridden    Boolean         @default(false)
  overrideReason  String?         @db.Text
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  payments        Payment[]
  discounts       FeeDiscount[]
  scholarships    FeeScholarship[]
  invoices        Invoice[]
  
  @@unique([studentId, feeStructureId])
  @@index([schoolId])
  @@index([studentId])
  @@index([status])
  @@index([academicYearId])
  @@index([dueDate])
  @@map("student_fees")
}

// ============================================
// PAYMENT MANAGEMENT
// ============================================

model Payment {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Student Fee
  studentFeeId    String
  studentFee      StudentFee      @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  
  // Student reference (denormalized for quick access)
  studentId       String
  
  // Payment details
  amount          Float
  paymentMethod   PaymentMethod   @default(CASH)
  
  // Transaction details
  transactionId   String?         @db.VarChar(100)  // Bank/Gateway transaction ID
  transactionDate DateTime?
  referenceNumber String?         @db.VarChar(100)  // Cheque/DD number
  
  // Bank details (for cheque/DD/transfer)
  bankName        String?         @db.VarChar(100)
  branchName      String?         @db.VarChar(100)
  
  // Online payment gateway details
  gatewayStatus   PaymentGatewayStatus?
  gatewayResponse Json?           // Full gateway response
  
  // Receipt
  receiptNumber   String          @unique @db.VarChar(50)
  receiptUrl      String?         @db.VarChar(500)
  receiptGeneratedAt DateTime?
  
  // Payment allocation (which fee components this payment covers)
  allocationDetails Json?         // [{componentId, componentName, amount}]
  
  // Late fee
  lateFeeAmount   Float           @default(0)
  
  // Payment date
  paidAt          DateTime        @default(now())
  
  // Recorded by
  recordedBy      String?         // User ID
  
  // Approval workflow (for offline payments)
  requiresApproval Boolean        @default(false)
  approvalStatus  String?         @db.VarChar(20)  // PENDING, APPROVED, REJECTED
  approvedBy      String?
  approvedAt      DateTime?
  
  // Reconciliation
  isReconciled    Boolean         @default(false)
  reconciledBy    String?
  reconciledAt    DateTime?
  
  // Status
  status          String          @default("SUCCESS") @db.VarChar(20)  // SUCCESS, FAILED, PENDING, CANCELLED
  
  // Notes
  remarks         String?         @db.Text
  
  // Reversal tracking
  isReversed      Boolean         @default(false)
  reversalReason  String?         @db.Text
  reversedBy      String?
  reversedAt      DateTime?
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  refunds         Refund[]
  auditLogs       FinanceAuditLog[]
  
  @@index([schoolId])
  @@index([studentFeeId])
  @@index([studentId])
  @@index([paidAt])
  @@index([receiptNumber])
  @@index([status])
  @@index([paymentMethod])
  @@map("payments")
}

// ============================================
// DISCOUNTS & SCHOLARSHIPS
// ============================================

model FeeDiscount {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Student Fee
  studentFeeId    String
  studentFee      StudentFee      @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  
  // Discount details
  name            String          @db.VarChar(255)  // e.g., "Sibling Discount", "Early Bird Discount"
  description     String?         @db.Text
  discountType    DiscountType    @default(PERCENTAGE)
  
  // Amount
  discountValue   Float           // Percentage or fixed amount
  discountAmount  Float           // Calculated discount amount
  
  // Applicability
  applicableComponents Json?      // Array of fee component IDs (null = all components)
  
  // Frequency
  isRecurring     Boolean         @default(false)
  recurringMonths Int?            // How many months/terms
  
  // Approval
  reason          String          @db.Text
  approvedBy      String?         // User ID
  approvedAt      DateTime?
  
  // Status
  isActive        Boolean         @default(true)
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  auditLogs       FinanceAuditLog[]
  
  @@index([schoolId])
  @@index([studentFeeId])
  @@index([studentId])
  @@map("fee_discounts")
}

model FeeScholarship {
  id              String            @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Student Fee
  studentFeeId    String
  studentFee      StudentFee        @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  
  // Scholarship details
  name            String            @db.VarChar(255)  // e.g., "Merit Scholarship", "Need-based Aid"
  description     String?           @db.Text
  scholarshipType DiscountType      @default(PERCENTAGE)
  
  // Amount
  scholarshipValue Float             // Percentage or fixed amount
  scholarshipAmount Float            // Calculated scholarship amount
  
  // Provider
  provider        String?           @db.VarChar(255)  // Government/Trust/Institution
  referenceNumber String?           @db.VarChar(100)
  
  // Validity
  validFrom       DateTime
  validTo         DateTime?
  
  // Applicability
  applicableComponents Json?        // Array of fee component IDs
  
  // Status
  status          ScholarshipStatus @default(PENDING)
  
  // Approval workflow
  appliedBy       String?           // User ID
  appliedAt       DateTime          @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  rejectionReason String?           @db.Text
  
  // Supporting documents
  documents       Json?             // [{name, url, type}]
  
  // Timestamps
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  auditLogs       FinanceAuditLog[]
  
  @@index([schoolId])
  @@index([studentFeeId])
  @@index([studentId])
  @@index([status])
  @@map("fee_scholarships")
}

// ============================================
// REFUNDS
// ============================================

model Refund {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Original Payment
  paymentId       String
  payment         Payment         @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  
  // Refund details
  refundAmount    Float
  refundReason    String          @db.Text
  refundType      String          @db.VarChar(50)  // ADMISSION_CANCELLATION, DUPLICATE_PAYMENT, OVERPAYMENT, OTHER
  
  // Refund method
  refundMethod    PaymentMethod   @default(BANK_TRANSFER)
  
  // Bank details (for refund transfer)
  accountHolderName String?       @db.VarChar(255)
  accountNumber   String?         @db.VarChar(50)
  ifscCode        String?         @db.VarChar(20)
  bankName        String?         @db.VarChar(100)
  
  // Transaction details
  transactionId   String?         @db.VarChar(100)
  transactionDate DateTime?
  
  // Status
  status          RefundStatus    @default(INITIATED)
  
  // Workflow
  initiatedBy     String          // User ID
  initiatedAt     DateTime        @default(now())
  approvedBy      String?
  approvedAt      DateTime?
  processedBy     String?
  processedAt     DateTime?
  completedAt     DateTime?
  
  // Rejection
  rejectionReason String?         @db.Text
  rejectedBy      String?
  rejectedAt      DateTime?
  
  // Supporting documents
  documents       Json?           // [{name, url, type}]
  
  // Notes
  remarks         String?         @db.Text
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  auditLogs       FinanceAuditLog[]
  
  @@index([schoolId])
  @@index([paymentId])
  @@index([studentId])
  @@index([status])
  @@map("refunds")
}

// ============================================
// INVOICES & RECEIPTS
// ============================================

model Invoice {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Student Fee
  studentFeeId    String
  studentFee      StudentFee      @relation(fields: [studentFeeId], references: [id], onDelete: Cascade)
  
  // Student reference
  studentId       String
  
  // Invoice details
  invoiceNumber   String          @unique @db.VarChar(50)
  invoiceDate     DateTime        @default(now())
  dueDate         DateTime?
  
  // Amounts
  subtotal        Float
  discountAmount  Float           @default(0)
  taxAmount       Float           @default(0)
  totalAmount     Float
  paidAmount      Float           @default(0)
  balanceAmount   Float
  
  // Tax details (GST/VAT)
  taxPercentage   Float?
  taxNumber       String?         @db.VarChar(50)  // GSTIN
  
  // Line items
  lineItems       Json            // [{description, feeType, amount, quantity}]
  
  // Status
  status          InvoiceStatus   @default(GENERATED)
  
  // PDF generation
  pdfUrl          String?         @db.VarChar(500)
  pdfGeneratedAt  DateTime?
  
  // Sent details
  sentTo          String?         @db.VarChar(255)  // Email
  sentAt          DateTime?
  
  // Generated by
  generatedBy     String?         // User ID
  
  // Notes
  notes           String?         @db.Text
  termsConditions String?         @db.Text
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@index([schoolId])
  @@index([studentFeeId])
  @@index([studentId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([invoiceDate])
  @@map("invoices")
}

// ============================================
// FINANCE SETTINGS
// ============================================

model FinanceSettings {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String          @unique
  
  // Receipt settings
  receiptPrefix   String          @default("RCP") @db.VarChar(10)
  receiptStartNumber Int          @default(1)
  currentReceiptNumber Int        @default(1)
  
  // Invoice settings
  invoicePrefix   String          @default("INV") @db.VarChar(10)
  invoiceStartNumber Int          @default(1)
  currentInvoiceNumber Int        @default(1)
  
  // Tax settings
  enableGST       Boolean         @default(false)
  gstNumber       String?         @db.VarChar(50)
  gstPercentage   Float?
  
  // Late fee settings
  enableLateFee   Boolean         @default(true)
  lateFeeType     String?         @db.VarChar(20)  // FIXED, PERCENTAGE
  lateFeeAmount   Float?
  lateFeePercentage Float?
  lateFeeGraceDays Int            @default(0)
  
  // Payment gateway settings
  enableOnlinePayment Boolean     @default(false)
  paymentGateway  String?         @db.VarChar(50)  // RAZORPAY, PAYTM, STRIPE, etc.
  gatewayConfig   Json?           // API keys, merchant ID, etc. (encrypted)
  
  // Reminder settings
  enablePaymentReminders Boolean  @default(true)
  reminderDaysBefore Json?        // [7, 3, 1] days before due date
  reminderDaysAfter Json?         // [1, 7, 15] days after due date
  
  // Approval settings
  requirePaymentApproval Boolean  @default(false)
  requireRefundApproval Boolean   @default(true)
  requireDiscountApproval Boolean @default(true)
  
  // Institution details (for invoices/receipts)
  institutionName String?         @db.VarChar(255)
  institutionAddress String?      @db.Text
  institutionPhone String?        @db.VarChar(20)
  institutionEmail String?        @db.VarChar(255)
  institutionLogo String?         @db.VarChar(500)
  
  // Bank details
  bankAccounts    Json?           // [{bankName, accountNumber, ifsc, branch}]
  
  // Timestamps
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@map("finance_settings")
}

// ============================================
// AUDIT & COMPLIANCE
// ============================================

model FinanceAuditLog {
  id              String          @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Entity reference
  entityType      String          @db.VarChar(50)  // PAYMENT, REFUND, DISCOUNT, SCHOLARSHIP, etc.
  entityId        String
  
  // Related entities (optional)
  paymentId       String?
  payment         Payment?        @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  refundId        String?
  refund          Refund?         @relation(fields: [refundId], references: [id], onDelete: Cascade)
  discountId      String?
  discount        FeeDiscount?    @relation(fields: [discountId], references: [id], onDelete: Cascade)
  scholarshipId   String?
  scholarship     FeeScholarship? @relation(fields: [scholarshipId], references: [id], onDelete: Cascade)
  
  // Action details
  action          String          @db.VarChar(50)  // CREATED, UPDATED, DELETED, APPROVED, REJECTED, etc.
  description     String          @db.Text
  
  // Data snapshot
  previousData    Json?           // State before change
  newData         Json?           // State after change
  
  // User details
  userId          String
  userName        String          @db.VarChar(255)
  userRole        String          @db.VarChar(50)
  ipAddress       String?         @db.VarChar(50)
  
  // Timestamp
  createdAt       DateTime        @default(now())
  
  @@index([schoolId, createdAt])
  @@index([entityType, entityId])
  @@index([userId])
  @@index([paymentId])
  @@index([refundId])
  @@map("finance_audit_logs")
}

// ============================================
// ASSIGNMENT MANAGEMENT MODULE
// ============================================

enum AssignmentType {
  HOMEWORK
  PRACTICE
  PROJECT
  ACTIVITY
  ASSESSMENT
}

enum AssignmentCategory {
  INDIVIDUAL
  GROUP
}

enum AssignmentSubmissionMode {
  ONLINE
  OFFLINE
  BOTH
}

enum AssignmentStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum AssignmentSubmissionStatus {
  PENDING
  SUBMITTED
  LATE
  EVALUATED
  RETURNED
}

enum AssignmentAttachmentType {
  FILE
  LINK
  IMAGE
}

model Assignment {
  id                    String                  @id @default(cuid())
  
  // Tenant isolation
  schoolId              String
  school                School                  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Academic context
  academicYearId        String
  academicYear          AcademicYear            @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  academicUnitId        String
  academicUnit          AcademicUnit            @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Optional: Specific section (null = all sections of the class)
  sectionId             String?
  section               AcademicUnit?           @relation("AssignmentSection", fields: [sectionId], references: [id], onDelete: SetNull)
  
  // Optional: Subject (null for activity-based assignments)
  subjectId             String?
  subject               Subject?                @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  
  // Created by teacher
  createdById           String
  createdBy             Teacher                 @relation(fields: [createdById], references: [id], onDelete: Cascade)
  
  // Assignment details
  title                 String                  @db.VarChar(255)
  description           String?                 @db.Text
  instructions          String?                 @db.Text
  
  // Type and category
  type                  AssignmentType          @default(HOMEWORK)
  category              AssignmentCategory      @default(INDIVIDUAL)
  submissionMode        AssignmentSubmissionMode @default(ONLINE)
  
  // Marks (optional)
  maxMarks              Int?
  
  // Deadlines
  dueDate               DateTime
  dueTime               String?                 @db.VarChar(10) // e.g., "23:59"
  
  // Publishing
  status                AssignmentStatus        @default(DRAFT)
  publishedAt           DateTime?
  scheduledFor          DateTime?               // For scheduled publishing
  
  // Submission rules
  allowLateSubmission   Boolean                 @default(false)
  allowResubmission     Boolean                 @default(false)
  resubmissionDeadline  DateTime?
  
  // Timestamps
  createdAt             DateTime                @default(now())
  updatedAt             DateTime                @updatedAt
  
  // Relations
  attachments           AssignmentAttachment[]
  submissions           AssignmentSubmission[]
  groups                AssignmentGroup[]
  
  @@index([schoolId, status])
  @@index([academicYearId])
  @@index([academicUnitId])
  @@index([subjectId])
  @@index([createdById])
  @@index([dueDate])
  @@index([status, publishedAt])
  @@map("assignments")
}

model AssignmentAttachment {
  id              String                    @id @default(cuid())
  
  // Assignment
  assignmentId    String
  assignment      Assignment                @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  // Attachment details
  type            AssignmentAttachmentType  @default(FILE)
  url             String                    @db.VarChar(500)
  fileName        String?                   @db.VarChar(255)
  fileSize        Int?                      // Size in bytes
  mimeType        String?                   @db.VarChar(100)
  
  // Display order
  displayOrder    Int                       @default(0)
  
  // Timestamps
  createdAt       DateTime                  @default(now())
  
  @@index([assignmentId])
  @@map("assignment_attachments")
}

model AssignmentSubmission {
  id              String                      @id @default(cuid())
  
  // Assignment
  assignmentId    String
  assignment      Assignment                  @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  // Submitter (either student or group)
  studentId       String?
  student         Student?                    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  groupId         String?
  group           AssignmentGroup?            @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  // Submission details
  submittedAt     DateTime?
  status          AssignmentSubmissionStatus  @default(PENDING)
  isLate          Boolean                     @default(false)
  
  // Student remarks/notes
  remarks         String?                     @db.Text
  
  // Resubmission tracking
  version         Int                         @default(1)
  previousSubmissionId String?
  
  // Timestamps
  createdAt       DateTime                    @default(now())
  updatedAt       DateTime                    @updatedAt
  
  // Relations
  attachments     SubmissionAttachment[]
  evaluation      AssignmentEvaluation?
  
  @@unique([assignmentId, studentId, version])
  @@index([assignmentId])
  @@index([studentId])
  @@index([groupId])
  @@index([status])
  @@index([submittedAt])
  @@map("assignment_submissions")
}

model SubmissionAttachment {
  id              String                @id @default(cuid())
  
  // Submission
  submissionId    String
  submission      AssignmentSubmission  @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  // Attachment details
  url             String                @db.VarChar(500)
  fileName        String?               @db.VarChar(255)
  fileSize        Int?                  // Size in bytes
  mimeType        String?               @db.VarChar(100)
  
  // Timestamps
  uploadedAt      DateTime              @default(now())
  
  @@index([submissionId])
  @@map("submission_attachments")
}

model AssignmentEvaluation {
  id                    String                @id @default(cuid())
  
  // Submission (one-to-one)
  submissionId          String                @unique
  submission            AssignmentSubmission  @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  
  // Evaluator
  evaluatedById         String
  evaluatedBy           Teacher               @relation(fields: [evaluatedById], references: [id], onDelete: Cascade)
  
  // Evaluation details
  marksObtained         Float?
  feedback              String?               @db.Text
  
  // Evaluation status
  status                String                @default("PENDING") @db.VarChar(20) // PENDING, EVALUATED, RETURNED
  evaluatedAt           DateTime?
  
  // Corrected work attachments
  evaluatedAttachments  Json?                 // [{url, fileName, fileSize}]
  
  // Timestamps
  createdAt             DateTime              @default(now())
  updatedAt             DateTime              @updatedAt
  
  @@index([evaluatedById])
  @@index([status])
  @@map("assignment_evaluations")
}

model AssignmentGroup {
  id              String                  @id @default(cuid())
  
  // Assignment
  assignmentId    String
  assignment      Assignment              @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  
  // Group details
  name            String                  @db.VarChar(100)
  leaderId        String?                 // Student ID of group leader
  
  // Timestamps
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt
  
  // Relations
  members         StudentGroupMember[]
  submissions     AssignmentSubmission[]
  
  @@unique([assignmentId, name])
  @@index([assignmentId])
  @@map("assignment_groups")
}

model StudentGroupMember {
  id              String            @id @default(cuid())
  
  // Group
  groupId         String
  group           AssignmentGroup   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  
  // Student
  studentId       String
  student         Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Timestamps
  joinedAt        DateTime          @default(now())
  
  @@unique([groupId, studentId])
  @@index([groupId])
  @@index([studentId])
  @@map("student_group_members")
}

// ============================================
// TEACHER ASSIGNMENT MODULE
// ============================================

enum TeacherAssignmentType {
  REGULAR         // Standard subject teacher
  TEAM_TEACHING   // Multiple teachers for same subject
  SUBSTITUTE      // Temporary replacement
  GUEST           // Visiting/Guest faculty
  ASSISTANT       // Teaching assistant
  LAB_INSTRUCTOR  // Practical/Lab instructor
  ACTIVITY        // Activity instructor (preschool)
}

model ClassTeacher {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Academic year specific
  academicYearId  String
  academicYear    AcademicYear  @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  
  // Class/Section/Batch
  academicUnitId  String
  academicUnit    AcademicUnit  @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Separate Class and Section fields for better organization
  classId         String?       // Parent class ID (e.g., "Class 5")
  sectionId       String?       // Section ID (e.g., "Section A")
  className       String?       @db.VarChar(100)  // Denormalized class name for display
  sectionName     String?       @db.VarChar(100)  // Denormalized section name for display
  
  // Teacher
  teacherId       String
  teacher         Teacher       @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Primary vs Co-class teacher
  isPrimary       Boolean       @default(true)
  
  // Effective period
  effectiveFrom   DateTime      @default(now())
  effectiveTo     DateTime?     // null = still active
  
  // Metadata
  assignedBy      String?       // Admin user ID who made assignment
  notes           String?       @db.VarChar(500)
  
  // Status
  isActive        Boolean       @default(true)
  
  // Timestamps
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // One primary class teacher per class per academic year (Application enforced for Active records)
  // @@unique([academicUnitId, academicYearId, isPrimary])
  @@index([schoolId, academicYearId])
  @@index([teacherId, academicYearId])
  @@index([academicUnitId, isActive])
  @@index([academicUnitId, academicYearId, isPrimary])
  @@index([classId, sectionId])
  @@map("class_teachers")
}

model TeacherClassAssignment {
  id              String                @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  school          School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Academic year specific
  academicYearId  String
  academicYear    AcademicYear          @relation(fields: [academicYearId], references: [id], onDelete: Cascade)
  
  // Teacher
  teacherId       String
  teacher         Teacher               @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  
  // Subject
  subjectId       String
  subject         Subject               @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  // Class/Section (can assign to parent class for all sections, or specific section)
  academicUnitId  String
  academicUnit    AcademicUnit          @relation(fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Assignment scope
  assignmentType  TeacherAssignmentType @default(REGULAR)
  
  // For team teaching - distinguish primary from secondary
  isPrimary       Boolean               @default(true)
  
  // Effective period
  effectiveFrom   DateTime              @default(now())
  effectiveTo     DateTime?             // null = still active
  
  // Workload tracking
  periodsPerWeek  Int?                  // Expected periods for this assignment
  
  // Metadata
  assignedBy      String?               // Admin user ID who made assignment
  notes           String?               @db.VarChar(500)
  
  // Status
  isActive        Boolean               @default(true)
  
  // Timestamps
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  
  // Prevent duplicate assignments
  // Unique assignment per year (Application enforced for Active records)
  // @@unique([academicUnitId, subjectId, teacherId, academicYearId])
  @@index([schoolId, academicYearId])
  @@index([teacherId, academicYearId])
  @@index([subjectId, academicYearId])
  @@index([academicUnitId, isActive])
  @@index([academicUnitId, subjectId, teacherId, academicYearId])
  @@map("teacher_class_assignments")
}

model TeacherAssignmentHistory {
  id              String        @id @default(cuid())
  
  // Tenant isolation
  schoolId        String
  
  // Reference to original assignment
  assignmentCategory  String    @db.VarChar(20)  // 'CLASS_TEACHER' or 'SUBJECT_TEACHER'
  assignmentId        String                    // ID of ClassTeacher or TeacherClassAssignment
  
  // Change details
  action          String        @db.VarChar(20)  // 'CREATED', 'MODIFIED', 'DEACTIVATED', 'REACTIVATED'
  previousData    Json?         // Snapshot before change
  newData         Json?         // Snapshot after change
  changeReason    String?       @db.VarChar(500)
  
  // Who made the change
  changedBy       String        // User ID
  changedAt       DateTime      @default(now())
  
  @@index([schoolId, assignmentId])
  @@index([schoolId, changedAt])
  @@index([assignmentCategory, assignmentId])
  @@map("teacher_assignment_history")
}

// ============================================
// EXAM TIMETABLE MANAGEMENT SYSTEM
// ============================================

model ExamTimetable {
  id              String   @id @default(cuid())
  
  schoolId        String
  school          School   @relation("SchoolExamTimetables", fields: [schoolId], references: [id], onDelete: Cascade)
  
  academicYearId  String
  academicYear    AcademicYear @relation("AcademicYearTimetables", fields: [academicYearId], references: [id], onDelete: Cascade)
  
  academicUnitId  String
  academicUnit    AcademicUnit @relation("AcademicUnitTimetables", fields: [academicUnitId], references: [id], onDelete: Cascade)
  
  // Separate class and section for better organization
  classId         String?
  className       String?  @db.VarChar(100)
  sectionId       String?
  sectionName     String?  @db.VarChar(100)
  
  examName        String   @db.VarChar(255)
  description     String?  @db.Text
  startDate       DateTime
  endDate         DateTime
  
  status          String   @default("DRAFT") @db.VarChar(20)
  
  publishedAt     DateTime?
  publishedBy     String?
  publisher       User?    @relation("TimetablePublisher", fields: [publishedBy], references: [id])
  
  createdBy       String
  creator         User     @relation("TimetableCreator", fields: [createdBy], references: [id])
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  slots           ExamTimetableSlot[]
  admitCards      AdmitCard[]
  timetableNotifications ExamTimetableNotification[]
  reportCards     ReportCard[]        @relation("TimetableReportCards")
  
  @@index([schoolId, academicYearId])
  @@index([academicUnitId, status])
  @@index([schoolId, classId])
  @@index([startDate, endDate])
  @@map("exam_timetables")
}

model ExamTimetableSlot {
  id              String   @id @default(cuid())
  
  timetableId     String
  timetable       ExamTimetable @relation(fields: [timetableId], references: [id], onDelete: Cascade)
  
  slotOrder       Int
  examDate        DateTime
  startTime       String   @db.VarChar(10)
  endTime         String   @db.VarChar(10)
  
  subjectId       String?
  subject         Subject? @relation("SlotSubject", fields: [subjectId], references: [id])
  
  maxMarks        Int?
  minMarks        Int?
  
  supervisorId    String?
  supervisor      Teacher? @relation("SlotSupervisor", fields: [supervisorId], references: [id])
  supervisorName  String?  @db.VarChar(255)
  
  type            String   @db.VarChar(20)
  
  room            String?  @db.VarChar(100)
  instructions    String?  @db.Text
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  slotAttendance  ExamSlotAttendance[]
  
  @@index([timetableId, slotOrder])
  @@index([examDate])
  @@index([subjectId])
  @@map("exam_timetable_slots")
}

model AdmitCard {
  id              String   @id @default(cuid())
  
  timetableId     String
  timetable       ExamTimetable @relation(fields: [timetableId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         Student  @relation("StudentAdmitCards", fields: [studentId], references: [id], onDelete: Cascade)
  
  hallTicketNo    String   @unique @db.VarChar(50)
  
  examCenter      String?  @db.VarChar(255)
  roomNumber      String?  @db.VarChar(50)
  seatNumber      String?  @db.VarChar(50)
  reportingTime   String?  @db.VarChar(10)
  
  instructions    String?  @db.Text
  
  pdfUrl          String?  @db.VarChar(500)
  generatedAt     DateTime?
  
  downloadCount   Int      @default(0)
  lastDownloadAt  DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([timetableId])
  @@index([studentId])
  @@index([hallTicketNo])
  @@map("admit_cards")
}

model ExamSlotAttendance {
  id              String   @id @default(cuid())
  
  slotId          String
  slot            ExamTimetableSlot @relation(fields: [slotId], references: [id], onDelete: Cascade)
  
  studentId       String
  student         Student  @relation("StudentExamSlotAttendance", fields: [studentId], references: [id], onDelete: Cascade)
  
  status          String   @db.VarChar(20)
  
  photoUrl        String?  @db.VarChar(500)
  
  markedBy        String
  marker          User     @relation("AttendanceMarker", fields: [markedBy], references: [id])
  
  remarks         String?  @db.VarChar(500)
  markedAt        DateTime @default(now())
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([slotId, studentId])
  @@index([slotId])
  @@index([studentId])
  @@index([status])
  @@map("exam_slot_attendance")
}

model ExamTimetableNotification {
  id              String   @id @default(cuid())
  
  timetableId     String
  timetable       ExamTimetable @relation(fields: [timetableId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation("ExamTimetableNotificationRecipient", fields: [userId], references: [id], onDelete: Cascade)
  
  type            String   @db.VarChar(50)
  title           String   @db.VarChar(255)
  message         String   @db.Text
  
  sentViaApp      Boolean  @default(false)
  sentViaEmail    Boolean  @default(false)
  sentViaSMS      Boolean  @default(false)
  
  emailSentAt     DateTime?
  emailStatus     String?  @db.VarChar(20)
  
  isRead          Boolean  @default(false)
  readAt          DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([userId, isRead])
  @@index([timetableId])
  @@index([type])
  @@map("exam_timetable_notifications")
}

model MarksChangeRequest {
  id              String   @id @default(cuid())
  
  resultId        String
  result          ExamResult @relation("ResultChangeRequests", fields: [resultId], references: [id], onDelete: Cascade)
  
  requestedBy     String
  requester       User     @relation("MarksChangeRequester", fields: [requestedBy], references: [id])
  
  oldMarks        Float
  newMarks        Float
  reason          String   @db.Text
  
  status          String   @default("PENDING") @db.VarChar(20)
  
  approvedBy      String?
  approver        User?    @relation("MarksChangeApprover", fields: [approvedBy], references: [id])
  
  approvalRemarks String?  @db.Text
  approvedAt      DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([resultId])
  @@index([requestedBy])
  @@index([status])
  @@map("marks_change_requests")
}

model AuditLog {
  id              String   @id @default(cuid())
  
  schoolId        String
  school          School   @relation("SchoolAuditLogs", fields: [schoolId], references: [id], onDelete: Cascade)
  
  entityType      String   @db.VarChar(50)
  entityId        String   @db.VarChar(255)
  
  action          String   @db.VarChar(50)
  
  userId          String
  user            User     @relation("AuditLogUser", fields: [userId], references: [id])
  
  oldValue        Json?
  newValue        Json?
  
  ipAddress       String?  @db.VarChar(50)
  userAgent       String?  @db.VarChar(500)
  
  createdAt       DateTime @default(now())
  
  @@index([schoolId, entityType, entityId])
  @@index([userId])
  @@index([createdAt])
  @@map("audit_logs")
}

model InstitutionSignature {
  id              String   @id @default(cuid())
  
  schoolId        String
  school          School   @relation("SchoolSignatures", fields: [schoolId], references: [id], onDelete: Cascade)
  
  type            String   @db.VarChar(50)
  
  teacherId       String?
  teacher         Teacher? @relation("TeacherSignatures", fields: [teacherId], references: [id])
  
  imageUrl        String   @db.VarChar(500)
  
  uploadedBy      String
  uploader        User     @relation("SignatureUploader", fields: [uploadedBy], references: [id])
  
  isActive        Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([schoolId, type, isActive])
  @@index([teacherId])
  @@map("institution_signatures")
}
